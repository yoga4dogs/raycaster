<!DOCTYPE html>
<html>
    <title>FUNCITY HEAVY INDUSTRIES RAYCAST DUNGEON</title>
    <link rel="shortcut icon" type="image/jpg" href="../images/smile.gif"/>

    <style>
        body {
            color: white;
            background-image: url('../play/images/marbledark.jpg');
            background-size: cover;
            font-family: MingLiU-ExtB, Microsoft Yi Baiti;
        }
        div.inline {
            float:left; 
        }
    </style>
    <body>
        <div style='background-color: rgb(0 0 0 / 0.5); 
            position: absolute; 
            width: 1608px;
            height: 800px;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);'>
        <canvas id="overhead_view" style="display: inline-block;" width="400px" height="400px"></canvas>
        <canvas id="pov_view" style="display: inline-block;" width="400px" height="400px"></canvas>
        <br>
        <center><a href="'http://funcity-online.com/" style='color: white;'>Home</a></center>
        </div>

        <script>
            width = {
                screen: 400,
                grid: 8
            }
            height = {
                screen: 400,
                grid: 8
            }
            grid_size = height.screen / height.grid;
            scale = 2;

            mouse = {
                x: width.screen/2,
                y: height.screen/2
            }
            
            document.getElementById("overhead_view").width = width.screen*scale;
            document.getElementById("overhead_view").height = height.screen*scale;
            overhead = document.getElementById("overhead_view").getContext("2d");
            overhead.scale(scale, scale);
            document.getElementById("pov_view").width = width.screen*scale;
            document.getElementById("pov_view").height = height.screen*scale;
            pov = document.getElementById("pov_view").getContext("2d");
            pov.scale(scale, scale);

            // this sucks ass
            document.addEventListener('keydown', function(event) {
                if(event.keyCode == 37) {
                    // left
                    player.dir = (player.dir+player.speed*1.5);
                } else if(event.keyCode == 39) {
                    // right
                    player.dir = (player.dir-player.speed*1.5);
                } else if(event.keyCode == 38) {
                    // forward
                    player.move(1);
                } else if(event.keyCode == 40) {
                    // back
                    player.move(-1);
                }
            });

            map = {
                layout: [
                    1, 1, 1, 1, 1, 1, 1, 1, 
                    1, 0, 0, 0, 0, 0, 0, 1,
                    1, 0, 1, 0, 0, 0, 0, 1,
                    1, 1, 1, 0, 0, 0, 0, 1,
                    1, 0, 0, 0, 1, 0, 1, 1,
                    1, 0, 1, 0, 1, 0, 0, 1,
                    1, 0, 1, 0, 1, 0, 0, 1,
                    1, 1, 1, 1, 1, 1, 1, 1
                ],
                draw_map: function() {
                    for(y=0; y < height.grid; y++) {
                        for(x=0; x < width.grid; x++) {
                            if(map.layout[width.grid*y+x]==1) { draw.square(overhead, x*grid_size, y*grid_size, "grey", grid_size); }
                        }
                    }
                }
            };

            player = {
                x: width.screen/2-20,
                y: height.screen/2-20,
                dir: 0,
                speed: 4,
                size: 4,
                fov: 66,
                ray_view: [],
                draw: function() { 
                    draw.square(overhead, player.x-player.size/2, player.y-player.size/2, "red", player.size);
                },
                draw_pointer: function() {
                    const dir_rotation = rotate(player.x, player.y, player.x+10, player.y, player.dir);
                    draw.line(overhead, player.x, player.y, dir_rotation[0], dir_rotation[1], "blue", 1);
                },
                move: function(direction) {
                    const facing = rotate(player.x, player.y, player.x+player.speed*direction, player.y, player.dir);
                    if (check_pos(facing[0], facing[1]) != 1) {
                        player.x = facing[0];
                        player.y = facing[1];
                    }
                },
                ray_test: function() {
                    ray_view = [];
                    for(d = 0 ; d < player.fov*2; d++) {
                        for(i = 1; i < width.screen; i++) {
                            const ray_dir = rotate(player.x, player.y, player.x+i, player.y, player.dir+d/2-player.fov/2);
                            if (check_pos(ray_dir[0], ray_dir[1]) == 1) {
                                draw.line(overhead, player.x, player.y, ray_dir[0], ray_dir[1], "white", 1);
                                ray_view.push(vector_distance(player.x, player.y, ray_dir[0], ray_dir[1]));
                                break;
                            }
                        }
                    }
                    ray_view.reverse();
                }
            };

            function check_pos(x, y) {
                const checkX = (x-(x%grid_size))/grid_size;
                const checkY = (y-(y%grid_size))/grid_size;
                return map.layout[width.grid*checkY+checkX];
            }

            function vector_distance(x1, y1, x2, y2) {
                return Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2));
            }

            function rotate(cx, cy, x, y, angle) {
                var radians = (Math.PI / 180) * angle,
                    cos = Math.cos(radians),
                    sin = Math.sin(radians),
                    nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
                    ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
                return [nx, ny];
            };

            clear = {
                overhead: function() {
                    overhead.clearRect(0, 0, width.screen, height.screen);
                    overhead.fillStyle = "#0a0a0a";
                    overhead.fillRect(0, 0, Math.max(width.screen, height.screen), Math.max(width.screen, height.screen));
                },
                pov: function() {
                    pov.clearRect(0, 0, width.screen, height.screen);
                    pov.fillStyle = "#0a0a0a";
                    pov.fillRect(0, 0, Math.max(width.screen, height.screen), Math.max(width.screen, height.screen));
                }
            }

            draw = {
                square: function(obj, x, y, c, s) {
                    obj.fillStyle = c;
                    obj.fillRect(x, y, s, s);
                },
                rect: function(obj, x, y, c, sx, sy) {
                    obj.fillStyle = c;
                    obj.fillRect(x, y, sx, sy);
                },
                line: function(obj, x1, y1, x2, y2, c, w) {
                    obj.strokeStyle = c;
                    obj.lineWidth = w;
                    obj.beginPath();
                    obj.moveTo(x1, y1);
                    obj.lineTo(x2, y2);
                    obj.stroke();
                }
            };

            function wall_view(view) {
                const slice_size = width.screen / view.length;
                for (i=0; i<view.length; i++) {
                    const distance_inverse = height.screen-view[i];
                    draw.rect(pov, 0+i*slice_size, height.screen/2 - distance_inverse/2, "rgb(" + distance_inverse + ", " + distance_inverse + ", " + distance_inverse + ")", slice_size, distance_inverse);
                }
            }

            function update() {
                clear.overhead();
                map.draw_map(map);
                player.ray_test();
                player.draw_pointer();
                player.draw();
                clear.pov();
                wall_view(ray_view);
                requestAnimationFrame(update);
            };

            update();

        </script>
    </body>
</html>
