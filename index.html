<!DOCTYPE html>
<html>
    <body>
        <canvas id="overhead_view" width="400px" height="400px"></canvas>
        <canvas id="pov_view" width="400px" height="400px"></canvas>

        <script>
            width = {
                screen: 400,
                grid: 8
            }
            height = {
                screen: 400,
                grid: 8
            }
            grid_size = height.screen / height.grid;
            scale = 2;

            mouse = {
                x: width.screen/2,
                y: height.screen/2
            }
            
            document.getElementById("overhead_view").width = width.screen*scale;
            document.getElementById("overhead_view").height = height.screen*scale;
            overhead = document.getElementById("overhead_view").getContext("2d");
            overhead.scale(scale, scale);
            document.getElementById("pov_view").width = width.screen;
            document.getElementById("pov_view").height = height.screen;
            pov = document.getElementById("pov_view").getContext("2d");
            pov.scale(scale, scale);

            // this sucks ass
            document.addEventListener('keydown', function(event) {
                if(event.keyCode == 37) {
                    // left
                    player.dir = (player.dir+player.speed);
                }
                else if(event.keyCode == 39) {
                    // right
                    player.dir = (player.dir-player.speed);
                } else if(event.keyCode == 38) {
                    // forward
                    player.move(1);
                } else if(event.keyCode == 40) {
                    // back
                    player.move(-1);
                }
            });

            map = {
                layout: [
                    1, 1, 1, 1, 1, 1, 1, 1, 
                    1, 0, 0, 0, 0, 0, 0, 1,
                    1, 1, 1, 1, 0, 0, 0, 1,
                    1, 0, 0, 0, 0, 0, 0, 1,
                    1, 0, 0, 0, 0, 1, 0, 1,
                    1, 0, 1, 0, 0, 1, 1, 1,
                    1, 0, 1, 0, 0, 0, 0, 1,
                    1, 1, 1, 1, 1, 1, 1, 1
                ],
                draw_map: function() {
                    for(y=0; y < height.grid; y++) {
                        for(x=0; x < width.grid; x++) {
                            if(map.layout[width.grid*y+x]==1) { draw.square(overhead, x*grid_size, y*grid_size, "grey", grid_size); }
                        }
                    }
                }
            };

            player = {
                x: width.screen/2,
                y: height.screen/2,
                dir: 0,
                speed: 4,
                size: 4,
                draw: function() { 
                    draw.square(overhead, player.x-player.size/2, player.y-player.size/2, "red", player.size);
                },
                draw_pointer: function() {
                    const dir_rotation = rotate(player.x, player.y, player.x+10, player.y, player.dir);
                    draw.line(overhead, player.x, player.y, dir_rotation[0], dir_rotation[1], "white", 1);
                },
                move: function(direction) {
                    const facing = rotate(player.x, player.y, player.x+player.speed*direction, player.y, player.dir);
                    if (player.check_pos(facing[0], facing[1]) != 1) {
                        player.x = facing[0];
                        player.y = facing[1];
                    }
                },
                check_pos: function(x, y) {
                    const checkX = (x-(x%grid_size))/grid_size;
                    const checkY = (y-(y%grid_size))/grid_size;
                    return map.layout[width.grid*checkY+checkX];
                }
            };

            function rotate(cx, cy, x, y, angle) {
                var radians = (Math.PI / 180) * angle,
                    cos = Math.cos(radians),
                    sin = Math.sin(radians),
                    nx = (cos * (x - cx)) + (sin * (y - cy)) + cx,
                    ny = (cos * (y - cy)) - (sin * (x - cx)) + cy;
                return [nx, ny];
            };

            clear = {
                overhead: function() {
                    overhead.clearRect(0, 0, width.screen, height.screen);
                    overhead.fillStyle = "#0a0a0a";
                    overhead.fillRect(0, 0, Math.max(width.screen, height.screen), Math.max(width.screen, height.screen));
                },
                pov: function() {
                    pov.clearRect(0, 0, width.screen, height.screen);
                    pov.fillStyle = "#0a0a0a";
                    pov.fillRect(0, 0, Math.max(width.screen, height.screen), Math.max(width.screen, height.screen));
                }
            }

            draw = {
                square: function(obj, x, y, c, s) {
                    obj.fillStyle = c;
                    obj.fillRect(x, y, s, s);
                },
                rect: function(obj, x, y, c, sx, sy) {
                    obj.fillStyle = c;
                    obj.fillRect(x, y, sx, sy);
                },
                line: function(obj, x1, y1, x2, y2, c, w) {
                    obj.strokeStyle = c;
                    obj.lineWidth = w;
                    obj.beginPath();
                    obj.moveTo(x1, y1);
                    obj.lineTo(x2, y2);
                    obj.stroke();
                }
            };

            function update() {
                clear.overhead();
                map.draw_map(map);
                player.draw_pointer();
                player.draw();
                requestAnimationFrame(update);
            };

            update();

        </script>
    </body>
</html>
